<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#ffffff">
    <meta name="description" content="DBP Mart - Premium E-commerce Application">
    <title>DBP Mart | Premium Products</title>
    
    <link rel="preconnect" href="https://cdn.tailwindcss.com">
    <link rel="preconnect" href="https://unpkg.com">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        brand: { light: '#f3e8ff', DEFAULT: '#9333ea', dark: '#581c87' },
                        dbp: { main: '#2563eb', dark: '#1e3a8a' }
                    },
                    animation: {
                        'pulse-slow': 'pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'float': 'float 5s ease-in-out infinite',
                        'slide-up': 'slideUpFade 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                        'marquee': 'marquee 25s linear infinite',
                    },
                    keyframes: {
                        float: { '0%': { transform: 'translateY(0px)' }, '50%': { transform: 'translateY(-5px)' }, '100%': { transform: 'translateY(0px)' } },
                        slideUpFade: { from: { opacity: '0', transform: 'translateY(20px)' }, to: { opacity: '1', transform: 'translateY(0)' } },
                        marquee: { '0%': { transform: 'translateX(100%)' }, '100%': { transform: 'translateX(-100%)' } }
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        
        body { 
            font-family: 'Inter', sans-serif; 
            -webkit-tap-highlight-color: transparent; 
            overscroll-behavior-y: none;
        }
        
        .glass {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(229, 231, 235, 0.5);
        }
        .dark .glass {
            background: rgba(17, 24, 39, 0.95);
            border: 1px solid rgba(255,255,255,0.05);
        }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }

        #static-loader {
            position: fixed; inset: 0; z-index: 9999;
            background: radial-gradient(circle at center, #ffffff 0%, #f3f4f6 100%);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: opacity 0.6s ease-out;
        }
        .dark #static-loader { 
            background: radial-gradient(circle at center, #1e293b 0%, #020617 100%);
        }
        
        .loader-gyro { width: 120px; height: 120px; position: relative; display: flex; align-items: center; justify-content: center; }
        .ring-outer { position: absolute; inset: 0; border-radius: 50%; border: 3px solid transparent; border-top-color: #3b82f6; border-right-color: #60a5fa; filter: drop-shadow(0 0 10px rgba(59, 130, 246, 0.5)); animation: spin-gyro 1.5s cubic-bezier(0.5, 0, 0.5, 1) infinite; }
        .ring-inner { position: absolute; inset: 15px; border-radius: 50%; border: 3px solid transparent; border-bottom-color: #a855f7; border-left-color: #d8b4fe; filter: drop-shadow(0 0 10px rgba(168, 85, 247, 0.5)); animation: spin-reverse 2.5s linear infinite; }
        .core-glow { position: absolute; width: 60px; height: 60px; background: radial-gradient(circle, rgba(59,130,246,0.8) 0%, transparent 70%); border-radius: 50%; animation: pulse-core 2s ease-in-out infinite; }
        .loader-text { z-index: 10; font-weight: 900; font-size: 1.5rem; background: linear-gradient(to right, #2563eb, #9333ea); -webkit-background-clip: text; -webkit-text-fill-color: transparent; letter-spacing: -1px; }
        .dark .loader-text { background: linear-gradient(to right, #60a5fa, #c084fc); -webkit-background-clip: text; }

        @keyframes spin-gyro { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes spin-reverse { 0% { transform: rotate(0deg); } 100% { transform: rotate(-360deg); } }
        @keyframes pulse-core { 0%, 100% { opacity: 0.3; transform: scale(0.8); } 50% { opacity: 0.8; transform: scale(1.2); } }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-950 text-gray-800 dark:text-gray-100 min-h-screen transition-colors duration-300 pb-24 md:pb-0 selection:bg-purple-200 selection:text-purple-900">
    
    <div id="static-loader">
        <div class="loader-gyro">
            <div class="core-glow"></div>
            <div class="ring-outer"></div>
            <div class="ring-inner"></div>
            <span class="loader-text">DBP</span>
        </div>
        <div class="mt-8 text-center animate-pulse">
            <p class="text-[10px] font-bold text-gray-400 uppercase tracking-[0.3em] mb-2">Developed By</p>
            <h1 class="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-gray-700 to-gray-900 dark:from-white dark:to-gray-400">DBP Systems</h1>
        </div>
    </div>

    <div id="root"></div>

    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo, useCallback } = React;

        // ==========================================
        // FIREBASE CLOUD DATABASE CONFIGURATION
        // ==========================================
        const firebaseConfig = {
            apiKey: "AIzaSyCbVT1L0Utr_T5a5xtd8WUPp9a3_oywdKE",
            authDomain: "dbp-mart.firebaseapp.com",
            projectId: "dbp-mart",
            storageBucket: "dbp-mart.firebasestorage.app",
            messagingSenderId: "815659641813",
            appId: "1:815659641813:web:1d26719d84ca9e6350ab5c"
        };
        
        // Initialize Firebase app and Firestore
        firebase.initializeApp(firebaseConfig);
        const firestoreDb = firebase.firestore();

        // The unified database wrapper
        const db = {
            getAll: async (storeName) => {
                try {
                    const snapshot = await firestoreDb.collection(storeName).get();
                    return snapshot.docs.map(doc => doc.data());
                } catch (error) {
                    console.error("Error fetching " + storeName, error);
                    return [];
                }
            },
            put: async (storeName, item) => {
                try {
                    if (!item.id) item.id = Date.now().toString(); 
                    const docId = String(item.id);
                    await firestoreDb.collection(storeName).doc(docId).set(item);
                    return item;
                } catch (error) {
                    console.error("Error saving to " + storeName, error);
                    throw error;
                }
            },
            delete: async (storeName, id) => {
                try {
                    await firestoreDb.collection(storeName).doc(String(id)).delete();
                } catch (error) {
                    console.error("Error deleting from " + storeName, error);
                    throw error;
                }
            }
        };

        const Icon = React.memo(({ path, className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d={path} />
            </svg>
        ));

        const icons = {
            home: "M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6",
            user: "M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z",
            cart: "M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z",
            search: "M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z",
            x: "M6 18L18 6M6 6l12 12",
            code: "M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4",
            lock: "M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z",
            edit: "M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z",
            trash: "M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16",
            plus: "M12 4v16m8-8H4",
            check: "M5 13l4 4L19 7",
            star: "M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z",
            camera: "M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z",
            chat: "M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z",
            download: "M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4",
            upload: "M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4",
            shield: "M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z",
            truck: "M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z", 
            return: "M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15",
            send: "M12 19l9 2-9-18-9 18 9-2zm0 0v-8",
            settings: "M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z M15 12a3 3 0 11-6 0 3 3 0 016 0z",
            heart: "M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z",
            heartSolid: "M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z"
        };

        const ToastContainer = ({ toasts }) => (
            <div className="fixed bottom-20 md:bottom-4 left-1/2 -translate-x-1/2 z-[160] flex flex-col gap-2 w-full max-w-sm px-4 pointer-events-none">
                {toasts.map(t => (
                    <div key={t.id} className={`glass p-3 rounded-xl shadow-2xl animate-slide-up flex items-center justify-between pointer-events-auto border-l-4 ${t.type === 'error' ? 'border-red-500' : t.type === 'success' ? 'border-green-500' : 'border-blue-500'}`}>
                        <div className="flex items-center gap-2">
                            <span className="text-lg">{t.type === 'error' ? '‚ùå' : t.type === 'success' ? '‚úÖ' : '‚ÑπÔ∏è'}</span>
                            <span className="text-sm font-bold text-gray-800 dark:text-white">{t.msg}</span>
                        </div>
                    </div>
                ))}
            </div>
        );

        const DBPModal = React.memo(({ onClose }) => (
            <div className="fixed inset-0 z-[110] flex items-center justify-center p-4">
                <div className="absolute inset-0 bg-black/70 backdrop-blur-md" onClick={onClose}></div>
                <div className="bg-white dark:bg-gray-900 rounded-2xl w-full max-w-sm relative shadow-2xl overflow-hidden animate-slide-up border border-blue-100 dark:border-blue-900">
                    <button onClick={onClose} className="absolute top-4 right-4 text-gray-400 hover:text-red-500 z-10 p-2"><Icon path={icons.x} className="w-6 h-6"/></button>
                    <div className="bg-gradient-to-r from-blue-800 to-blue-600 p-6 text-white relative">
                        <div className="absolute -left-10 -bottom-10 w-32 h-32 bg-white opacity-10 rounded-full blur-2xl"></div>
                        <div className="flex flex-col items-center justify-center mb-2">
                            <div className="w-14 h-14 bg-white rounded-xl flex items-center justify-center text-blue-700 font-black text-2xl shadow-lg mb-3">DBP</div>
                            <h2 className="font-bold text-lg">Official Tech Partner</h2>
                            <div className="flex items-center gap-1 text-[10px] font-mono bg-black/20 px-3 py-1 rounded-full mt-2"><Icon path={icons.code} className="w-3 h-3" /> VERIFIED DEVELOPER</div>
                        </div>
                    </div>
                    <div className="p-6">
                        <p className="text-gray-600 dark:text-gray-300 text-sm text-center mb-6">Need a high-performance website? <strong className="text-blue-600 dark:text-blue-400">We build stunning starter sites for startups.</strong></p>
                        <div className="bg-blue-50 dark:bg-gray-800 p-4 rounded-xl border border-blue-100 dark:border-gray-700 mb-4 text-center">
                            <p className="text-[10px] font-bold uppercase text-gray-500 mb-1">Launch Your Business</p>
                            <a href="tel:9827700975" className="text-2xl font-black text-gray-800 dark:text-white hover:text-blue-600 transition-colors block">9827700975</a>
                        </div>
                        <button onClick={onClose} className="w-full py-3 rounded-xl border border-gray-200 dark:border-gray-700 text-gray-500 text-sm font-bold active:scale-95 transition-transform">Close</button>
                    </div>
                </div>
            </div>
        ));

        const App = () => {
            const [products, setProducts] = useState([]);
            const [orders, setOrders] = useState([]);
            const [feedbacks, setFeedbacks] = useState([]);
            const [users, setUsers] = useState([]);
            const [categories, setCategories] = useState([]);
            
            // CHECK FOR OWNER
            const [currentUser, setCurrentUser] = useState(() => { try { return JSON.parse(localStorage.getItem('dbp-mart-current-user')) || null } catch { return null } });
            const isOwner = currentUser && currentUser.phone === '9827700975';
            
            const [cart, setCart] = useState([]);
            const [wishlist, setWishlist] = useState([]); 
            const [toasts, setToasts] = useState([]); 
            const [darkMode, setDarkMode] = useState(false);
            const [view, setView] = useState('home'); 
            const [showCart, setShowCart] = useState(false);
            const [showCheckout, setShowCheckout] = useState(false);
            const [showDBP, setShowDBP] = useState(false);
            const [showAuthModal, setShowAuthModal] = useState(false);
            
            const [selectedProduct, setSelectedProduct] = useState(null);
            const [activeImageIdx, setActiveImageIdx] = useState(0); 
            
            const [authMode, setAuthMode] = useState('login');
            const [returnModalOpen, setReturnModalOpen] = useState(false);
            const [returnOrderTarget, setReturnOrderTarget] = useState(null);
            const [returnReason, setReturnReason] = useState('');
            
            const [search, setSearch] = useState('');
            const [activeCategory, setActiveCategory] = useState('all');
            const [trackPhone, setTrackPhone] = useState('');
            
            // Hero Highlights State
            const [heroTitle, setHeroTitle] = useState('');
            const [heroSubtitle, setHeroSubtitle] = useState('');
            const [trendingMsg, setTrendingMsg] = useState('');
            
            const [checkoutForm, setCheckoutForm] = useState({ 
                name: '', phone: '', pincode: '', country: 'India', 
                state: '', district: '', detailedAddress: '' 
            });

            const [feedbackForm, setFeedbackForm] = useState({ name: '', message: '', rating: 5, image: '' });
            const [productReviewForm, setProductReviewForm] = useState({ name: '', message: '', rating: 5, image: '' });
            const [authForm, setAuthForm] = useState({ name: '', phone: '', password: '' });

            const [isAdmin, setIsAdmin] = useState(false);
            const [adminPassInput, setAdminPassInput] = useState('');
            const [savedAdminPass, setSavedAdminPass] = useState(null);
            const [adminTab, setAdminTab] = useState('products');
            const [adminSearch, setAdminSearch] = useState('');
            const [passChangeForm, setPassChangeForm] = useState({old:'', new:'', confirm:''});
            const [newCat, setNewCat] = useState('');
            
            // Admin Panel Highlight Editing State
            const [adminTrending, setAdminTrending] = useState('');
            const [adminHeroTitle, setAdminHeroTitle] = useState('');
            const [adminHeroSubtitle, setAdminHeroSubtitle] = useState('');

            const [productForm, setProductForm] = useState({ 
                id: null, name: '', price: '', originalPrice: '', description: '', 
                images: [], category: '', isRec: false, offer: '', inStock: true,
                deliveryFee: 0, returnable: true
            });

            const fileInputRef = useRef(null);

            // 1. Initial Data Load from Firebase
            useEffect(() => {
                const loader = document.getElementById('static-loader');
                if(loader) {
                    loader.style.opacity = '0';
                    setTimeout(() => loader.remove(), 600);
                }
                const loadData = async () => {
                    try {
                        const [p, o, f, u, s] = await Promise.all([
                            db.getAll('products'), 
                            db.getAll('orders'), 
                            db.getAll('feedbacks'), 
                            db.getAll('users'),
                            db.getAll('settings')
                        ]);
                        setProducts(p); setOrders(o); setFeedbacks(f); setUsers(u);

                        // Load Admin Password
                        const passEntry = s.find(item => item.id === 'admin_pass');
                        if (passEntry) setSavedAdminPass(passEntry.value);
                        else {
                            const defaultPass = 'DBPMart@2024#Secure';
                            await db.put('settings', { id: 'admin_pass', value: defaultPass });
                            setSavedAdminPass(defaultPass);
                        }

                        // Load Categories
                        const catEntry = s.find(item => item.id === 'categories');
                        const initialCats = catEntry ? catEntry.value : [
                            {id: 'cat1', name: 'Electronics'}, 
                            {id: 'cat2', name: 'Accessories'}
                        ];
                        if(!catEntry) db.put('settings', { id: 'categories', value: initialCats });
                        setCategories(initialCats);

                        // Load Highlights (Trending, Hero Title, Hero Subtitle)
                        const trendEntry = s.find(item => item.id === 'trending_msg');
                        const initialTrend = trendEntry ? trendEntry.value : 'üöÄ Big Sale is Live! ‚Ä¢ üî• Up to 50% off ‚Ä¢ ‚ö° Fast Worldwide Delivery';
                        if(!trendEntry) db.put('settings', { id: 'trending_msg', value: initialTrend });
                        setTrendingMsg(initialTrend); setAdminTrending(initialTrend);

                        const heroTitleEntry = s.find(item => item.id === 'hero_title');
                        const initialHeroTitle = heroTitleEntry ? heroTitleEntry.value : 'Main Highlight Title';
                        if(!heroTitleEntry) db.put('settings', { id: 'hero_title', value: initialHeroTitle });
                        setHeroTitle(initialHeroTitle); setAdminHeroTitle(initialHeroTitle);

                        const heroSubEntry = s.find(item => item.id === 'hero_subtitle');
                        const initialHeroSub = heroSubEntry ? heroSubEntry.value : 'Highlight Subtitle';
                        if(!heroSubEntry) db.put('settings', { id: 'hero_subtitle', value: initialHeroSub });
                        setHeroSubtitle(initialHeroSub); setAdminHeroSubtitle(initialHeroSub);

                    } catch (e) { console.error("Firebase DB Error", e); }
                };
                loadData();
            }, []);

            useEffect(() => { try { localStorage.setItem('dbp-mart-current-user', JSON.stringify(currentUser)); } catch(e) {} }, [currentUser]);
            useEffect(() => { document.documentElement.className = darkMode ? 'dark' : ''; }, [darkMode]);
            useEffect(() => { if (currentUser && currentUser.wishlist) setWishlist(currentUser.wishlist); else setWishlist([]); }, [currentUser]);
            
            // SMART FILL: Auto-fill checkout, track fields, and review forms based on login
            useEffect(() => { 
                if (currentUser) {
                    setCheckoutForm(prev => ({ ...prev, name: currentUser.name, phone: currentUser.phone }));
                    setTrackPhone(currentUser.phone);
                    setFeedbackForm(prev => ({ ...prev, name: currentUser.name }));
                    setProductReviewForm(prev => ({ ...prev, name: currentUser.name }));
                } else {
                    setTrackPhone('');
                    setCheckoutForm(prev => ({ ...prev, name: '', phone: '' }));
                    setFeedbackForm(prev => ({ ...prev, name: '' }));
                    setProductReviewForm(prev => ({ ...prev, name: '' }));
                }
            }, [currentUser, showCheckout, view, selectedProduct]);

            const addToast = useCallback((msg, type = 'info') => {
                const id = Date.now();
                setToasts(prev => [...prev, { id, msg, type }]);
                setTimeout(() => setToasts(prev => prev.filter(t => t.id !== id)), 3000);
            }, []);

            const handleAuth = async () => {
                if (authMode === 'signup') {
                    if (!authForm.name || !authForm.phone || !authForm.password) return addToast("All fields required", "error");
                    if (users.find(u => u.phone === authForm.phone)) return addToast("User already exists!", "error");
                    const newUser = { ...authForm, id: Date.now().toString(), joined: new Date().toLocaleDateString(), wishlist: [] };
                    await db.put('users', newUser);
                    setUsers([...users, newUser]);
                    setCurrentUser(newUser);
                    setShowAuthModal(false);
                    addToast("Welcome to DBP Mart!", "success");
                } else {
                    const user = users.find(u => u.phone === authForm.phone && u.password === authForm.password);
                    if (user) { setCurrentUser(user); setShowAuthModal(false); addToast(`Welcome back, ${user.name}!`, "success"); } 
                    else { addToast("Invalid Credentials", "error"); }
                }
                setAuthForm({ name: '', phone: '', password: '' });
            };

            const logout = () => { setCurrentUser(null); setWishlist([]); setView('home'); addToast("Logged out successfully", "info"); };

            const addToCart = useCallback((p) => {
                if(p.inStock === false) return addToast("Sorry, this item is out of stock!", "error");
                const exist = cart.find(x => x.id === p.id);
                const img = (p.images && p.images.length > 0) ? p.images[0] : p.image;
                if(exist) setCart(cart.map(x => x.id === p.id ? {...x, qty: x.qty + 1} : x));
                else setCart([...cart, {...p, image: img, qty: 1}]);
                addToast("Added to Cart!", "success");
            }, [cart]);

            const updateCartQty = (id, delta) => {
                setCart(prevCart => prevCart.map(item => {
                    if (item.id === id) {
                        const newQty = item.qty + delta;
                        if (newQty < 1) return item; 
                        if (delta > 0 && item.inStock === false) { addToast("Sorry, limit reached!", "error"); return item; }
                        return { ...item, qty: newQty };
                    }
                    return item;
                }));
            };

            const removeFromCart = (id) => setCart(cart.filter(x => x.id !== id));

            const toggleWishlist = async (e, p) => {
                e.preventDefault();
                e.stopPropagation();
                let newWishlist;
                if (wishlist.includes(p.id)) { newWishlist = wishlist.filter(id => id !== p.id); addToast("Removed from Wishlist", "info"); } 
                else { newWishlist = [...wishlist, p.id]; addToast("Added to Wishlist", "success"); }
                setWishlist(newWishlist);
                if (currentUser) {
                    const updatedUser = { ...currentUser, wishlist: newWishlist };
                    await db.put('users', updatedUser);
                    setCurrentUser(updatedUser);
                    setUsers(users.map(u => u.id === updatedUser.id ? updatedUser : u));
                }
            };

            const buyNow = (p) => { addToCart(p); setSelectedProduct(null); setShowCart(false); setShowCheckout(true); };

            const placeOrder = async () => {
                if(!checkoutForm.name || !checkoutForm.phone) return addToast("Name & Phone required!", "error");
                if(!checkoutForm.pincode || !checkoutForm.state || !checkoutForm.district || !checkoutForm.detailedAddress) return addToast("Please fill the complete address!", "error");
                const fullAddress = `${checkoutForm.detailedAddress}, ${checkoutForm.district}, ${checkoutForm.state}, ${checkoutForm.country} - ${checkoutForm.pincode}`;
                const total = cart.reduce((a,c) => a + (c.price * c.qty) + ((c.deliveryFee || 0) * c.qty), 0);
                const orderCustomer = { name: checkoutForm.name, phone: checkoutForm.phone, address: fullAddress, customerId: currentUser ? currentUser.phone : null };
                const order = { id: Date.now().toString(), items: cart, customer: orderCustomer, total, date: new Date().toLocaleString(), status: 'Pending Verification', returnRequest: null };
                
                // Execute window.open FIRST to bypass popup blocker
                let msg = `*üåü New Order - DBP Mart üåü*\n\n*üë§ Customer:* ${checkoutForm.name}\n*üì± Phone:* ${checkoutForm.phone}\n\n*üìç Shipping Address:*\n${checkoutForm.detailedAddress}\n${checkoutForm.district}, ${checkoutForm.state}\n${checkoutForm.country} - ${checkoutForm.pincode}\n\n*üõí Items:*\n`;
                cart.forEach(item => { 
                    msg += `‚Ä¢ ${item.name} (x${item.qty}) - ‚Çπ${item.price * item.qty}`;
                    if(item.deliveryFee > 0) msg += ` (+ ‚Çπ${item.deliveryFee * item.qty} Delivery)`;
                    msg += `\n`; 
                });
                msg += `\n*üí∞ Total: ‚Çπ${total}*\n--------------------------------\n*Please send Payment QR Code*`;
                
                window.open(`https://wa.me/919827700975?text=${encodeURIComponent(msg)}`, '_blank');

                await db.put('orders', order);
                setOrders([...orders, order]);
                setCart([]); setShowCheckout(false); setCheckoutForm({name: currentUser ? currentUser.name : '', phone: currentUser ? currentUser.phone : '', pincode:'', state:'', district:'', detailedAddress:'', country: 'India'});
                addToast("Order Placed Successfully!", "success");
            };

            const initiateReturn = (order) => { setReturnOrderTarget(order); setReturnModalOpen(true); setReturnReason(''); };
            const submitReturn = async () => {
                if(!returnReason.trim()) return addToast("Please provide a reason", "error");
                const updatedOrder = { ...returnOrderTarget, returnRequest: { reason: returnReason, status: 'Pending', date: new Date().toLocaleString() } };
                await db.put('orders', updatedOrder);
                setOrders(orders.map(o => o.id === updatedOrder.id ? updatedOrder : o));
                setReturnModalOpen(false); setReturnOrderTarget(null); addToast("Return Request Sent!", "success");
            };
            const handleReturnAction = async (orderId, action) => {
                const targetOrder = orders.find(o => o.id === orderId);
                if (!targetOrder) return;
                const updatedOrder = { ...targetOrder };
                if (action === 'Approve') { updatedOrder.status = 'Returned'; updatedOrder.returnRequest.status = 'Approved'; } 
                else { updatedOrder.returnRequest.status = 'Rejected'; }
                await db.put('orders', updatedOrder);
                setOrders(orders.map(o => o.id === orderId ? updatedOrder : o));
                addToast(`Return request ${action}d`, "success");
            };

            const resizeImage = (file) => {
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = new Image();
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            let width = img.width, height = img.height;
                            const max = 800;
                            if (width > max || height > max) { if (width > height) { height *= max / width; width = max; } else { width *= max / height; height = max; } }
                            canvas.width = width; canvas.height = height;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, width, height);
                            resolve(canvas.toDataURL('image/jpeg', 0.7));
                        };
                        img.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                });
            };
            const handleImage = (e, callback) => { const file = e.target.files[0]; if(file) resizeImage(file).then(callback); };
            const handleProductImages = async (e) => {
                const files = Array.from(e.target.files);
                if (files.length === 0) return;
                try { const newImages = await Promise.all(files.map(resizeImage)); setProductForm(prev => ({ ...prev, images: [...(prev.images || []), ...newImages] })); } 
                catch (error) { addToast("Failed to load images", "error"); }
            };
            const removeProductImage = (index) => { setProductForm(prev => ({ ...prev, images: prev.images.filter((_, i) => i !== index) })); };

            const adminLogin = () => { 
                if(adminPassInput.trim() === savedAdminPass) { 
                    setIsAdmin(true); 
                    addToast("Admin Access Granted", "success"); 
                } else { 
                    addToast("Wrong Password", "error"); 
                } 
            };
            
            const changeAdminPassword = async () => {
                if(passChangeForm.old.trim() !== savedAdminPass) return addToast("Incorrect Old Password", "error");
                if(passChangeForm.new.length < 4) return addToast("Password too short", "error");
                if(passChangeForm.new !== passChangeForm.confirm) return addToast("Passwords do not match", "error");
                
                await db.put('settings', { id: 'admin_pass', value: passChangeForm.new });
                setSavedAdminPass(passChangeForm.new); 
                addToast("Password Updated Successfully!", "success"); 
                setPassChangeForm({old:'', new:'', confirm:''});
            };

            const addCategory = async () => {
                if(!newCat.trim()) return;
                const newObj = { id: Date.now().toString(), name: newCat.trim() };
                const updated = [...categories, newObj];
                await db.put('settings', { id: 'categories', value: updated });
                setCategories(updated);
                setNewCat('');
                addToast("Category Added", "success");
            };

            const deleteCategory = async (id) => {
                const updated = categories.filter(c => c.id !== id);
                await db.put('settings', { id: 'categories', value: updated });
                setCategories(updated);
                addToast("Category Deleted", "info");
            };

            const saveHighlights = async () => {
                await db.put('settings', { id: 'trending_msg', value: adminTrending });
                await db.put('settings', { id: 'hero_title', value: adminHeroTitle });
                await db.put('settings', { id: 'hero_subtitle', value: adminHeroSubtitle });
                setTrendingMsg(adminTrending);
                setHeroTitle(adminHeroTitle);
                setHeroSubtitle(adminHeroSubtitle);
                addToast("Highlights Updated", "success");
            };

            const saveProduct = async () => {
                if(!productForm.name || !productForm.price) return addToast("Name & Price required", "error");
                const price = parseFloat(productForm.price) || 0;
                const deliveryFee = parseFloat(productForm.deliveryFee) || 0;
                const originalPrice = productForm.originalPrice ? parseFloat(productForm.originalPrice) : null;
                const mainImage = (productForm.images && productForm.images.length > 0) ? productForm.images[0] : '';
                
                const cat = productForm.category || (categories.length > 0 ? categories[0].id : 'general');
                const newProduct = { ...productForm, price, deliveryFee, originalPrice, image: mainImage, category: cat, id: productForm.id ? String(productForm.id) : Date.now().toString() };
                
                try {
                    await db.put('products', newProduct);
                    if(productForm.id) setProducts(products.map(p => p.id === productForm.id ? newProduct : p)); else setProducts([...products, newProduct]);
                    setProductForm({ id: null, name: '', price: '', originalPrice: '', description: '', images: [], category: '', isRec: false, offer: '', inStock: true, deliveryFee: 0, returnable: true });
                    addToast(productForm.id ? "Product Updated!" : "Product Added!", "success");
                } catch (err) { addToast("Error Saving Product: " + err.message, "error"); }
            };
            const editProduct = (p) => { setProductForm({ ...p, price: p.price.toString(), originalPrice: p.originalPrice ? p.originalPrice.toString() : '', inStock: p.inStock !== undefined ? p.inStock : true, images: p.images || (p.image ? [p.image] : []), deliveryFee: p.deliveryFee || 0, returnable: p.returnable !== undefined ? p.returnable : true }); window.scrollTo({top:0, behavior:'smooth'}); };
            const deleteProduct = async (id) => { if(confirm("Delete?")) { await db.delete('products', id); setProducts(products.filter(x => x.id !== id)); addToast("Product Deleted", "info"); } };
            const updateOrderStatus = async (id, newStatus) => {
                const targetOrder = orders.find(o => o.id === id);
                if(targetOrder) { const updated = { ...targetOrder, status: newStatus }; await db.put('orders', updated); setOrders(orders.map(o => o.id === id ? updated : o)); addToast("Order Status Updated", "success"); }
            };
            
            const exportData = () => { const data = { products, orders, feedbacks, users }; const blob = new Blob([JSON.stringify(data)], { type: 'application/json' }); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `dbp_mart_backup_${new Date().toISOString().slice(0,10)}.json`; a.click(); };
            const importData = (e) => {
                const file = e.target.files[0]; if (!file) return;
                const reader = new FileReader();
                reader.onload = async (event) => { try { const data = JSON.parse(event.target.result); if(data.products) { for (const p of data.products) await db.put('products', p); setProducts(data.products); } if(data.orders) { for (const o of data.orders) await db.put('orders', o); setOrders(data.orders); } if(data.feedbacks) { for (const f of data.feedbacks) await db.put('feedbacks', f); setFeedbacks(data.feedbacks); } if(data.users) { for (const u of data.users) await db.put('users', u); setUsers(data.users); } addToast("Data Imported Successfully!", "success"); } catch (err) { addToast("Invalid file format", "error"); } };
                reader.readAsText(file);
            };

            const submitGlobalFeedback = async () => {
                if(!feedbackForm.name || !feedbackForm.message) return addToast("Please fill Name & Message", "error");
                const newFeedback = {...feedbackForm, id: Date.now().toString(), date: new Date().toLocaleDateString()};
                await db.put('feedbacks', newFeedback); 
                setFeedbacks([newFeedback, ...feedbacks]); 
                // Keep the name populated if logged in
                setFeedbackForm({name: currentUser ? currentUser.name : '', message:'', rating: 5, image: ''}); 
                addToast("Review Submitted!", "success"); 
                setView('home');
            };
            
            const submitProductFeedback = async (productId) => {
                if(!productReviewForm.name || !productReviewForm.message) return addToast("Please fill Name & Message", "error");
                const newReview = { ...productReviewForm, id: Date.now().toString(), productId: productId, date: new Date().toLocaleDateString() };
                await db.put('feedbacks', newReview); 
                setFeedbacks([newReview, ...feedbacks]); 
                // Keep the name populated if logged in
                setProductReviewForm({name: currentUser ? currentUser.name : '', message:'', rating: 5, image: ''}); 
                addToast("Review Submitted!", "success");
            };
            
            const filteredProducts = useMemo(() => {
                let result = products;
                if (activeCategory !== 'all') {
                    result = result.filter(p => p.category === activeCategory);
                }
                if (search.trim()) {
                    const query = search.toLowerCase();
                    result = result.filter(p => 
                        (p.name && p.name.toLowerCase().includes(query)) || 
                        (p.description && p.description.toLowerCase().includes(query)) ||
                        (p.category && p.category.toLowerCase().includes(query)) ||
                        (p.offer && p.offer.toLowerCase().includes(query))
                    );
                }
                return result;
            }, [products, search, activeCategory]);

            const galleryImages = useMemo(() => {
                if (!selectedProduct) return [];
                return (selectedProduct.images && selectedProduct.images.length > 0) ? selectedProduct.images : [selectedProduct.image].filter(Boolean);
            }, [selectedProduct]);

            return (
                <div className="flex flex-col min-h-screen relative">
                    <ToastContainer toasts={toasts} />
                    <div onClick={() => setShowDBP(true)} className="fixed bottom-20 md:bottom-6 left-4 z-30 flex items-center gap-2 bg-white dark:bg-gray-800 pl-1 pr-4 py-1.5 rounded-full shadow-xl border border-blue-100 dark:border-blue-900 cursor-pointer active:scale-95 transition-transform animate-float">
                        <div className="w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center text-white text-[10px] font-bold">DBP</div>
                        <span className="text-xs font-bold text-gray-600 dark:text-gray-300">Need a site?</span>
                    </div>

                    <header className="glass sticky top-0 z-40 px-4 py-3 shadow-sm">
                        <div className="max-w-7xl mx-auto flex items-center justify-between">
                            <h1 onClick={() => setView('home')} className="text-xl font-black text-gray-900 dark:text-white cursor-pointer flex items-center gap-2"><span className="text-3xl">üíé</span> DBP <span className="text-purple-600">Mart</span></h1>
                            <div className="hidden md:flex gap-8 items-center font-bold text-sm text-gray-600 dark:text-gray-300">
                                <a href="#shop" onClick={(e) => { e.preventDefault(); setView('home'); }} className="hover:text-purple-600">Shop</a>
                                <a href="#orders" onClick={(e) => { e.preventDefault(); setView('track'); }} className="hover:text-purple-600">Orders</a>
                                <a href="#reviews" onClick={(e) => { e.preventDefault(); setView('feedback'); }} className="hover:text-purple-600">Reviews</a>
                                {isOwner && (
                                    <a href="#admin" onClick={(e) => { e.preventDefault(); setView('admin'); }} className="text-gray-300 dark:text-gray-800 hover:text-purple-600 text-xs transition-colors font-bold">Admin</a>
                                )}
                            </div>
                            <div className="hidden md:flex relative w-64"><input type="text" placeholder="Search..." value={search} onChange={e => setSearch(e.target.value)} className="w-full pl-9 pr-4 py-2 rounded-full bg-gray-100 dark:bg-gray-800 text-sm outline-none border border-transparent focus:border-purple-500 transition-all"/><Icon path={icons.search} className="absolute left-3 top-2.5 w-4 h-4 text-gray-400"/></div>
                            <div className="flex items-center gap-3"><button onClick={() => setDarkMode(!darkMode)} className="p-2 rounded-full text-lg active:scale-90 transition-transform">{darkMode ? '‚òÄÔ∏è' : 'üåô'}</button><button onClick={() => setShowCart(true)} className="p-2 relative rounded-full bg-purple-100 dark:bg-gray-800 text-purple-600 dark:text-purple-400 active:scale-90 transition-transform"><Icon path={icons.cart} className="w-6 h-6" />{cart.length > 0 && <span className="absolute -top-1 -right-1 bg-red-500 text-white text-[10px] font-bold w-4 h-4 rounded-full flex items-center justify-center">{cart.length}</span>}</button>{currentUser ? (<button onClick={() => setView('profile')} className="hidden md:flex items-center gap-2 px-3 py-1.5 rounded-full bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors"><div className="w-6 h-6 rounded-full bg-purple-600 text-white flex items-center justify-center text-xs font-bold">{currentUser.name.charAt(0)}</div><span className="text-xs font-bold truncate max-w-[80px]">{currentUser.name}</span></button>) : (<button onClick={() => { setAuthMode('login'); setShowAuthModal(true); }} className="hidden md:flex items-center gap-1 px-4 py-2 rounded-full bg-black dark:bg-white text-white dark:text-black text-xs font-bold hover:opacity-80 transition-opacity">Sign In</button>)}</div>
                        </div>
                    </header>

                    <main className="flex-1 max-w-7xl mx-auto w-full p-4">
                        {view === 'home' && (
                            <div className="animate-slide-up">
                                {trendingMsg && (
                                    <div className="bg-gradient-to-r from-blue-700 to-purple-700 text-white overflow-hidden py-2 -mx-4 px-4 md:rounded-xl md:mx-0 mb-4 shadow-inner relative flex items-center">
                                        <div className="whitespace-nowrap animate-marquee font-bold text-xs tracking-widest uppercase">
                                            {trendingMsg} &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {trendingMsg}
                                        </div>
                                    </div>
                                )}

                                <div className="mb-4 md:hidden relative"><input type="text" placeholder="Search products, descriptions, or tags..." value={search} onChange={e => setSearch(e.target.value)} className="w-full pl-10 pr-4 py-3 rounded-xl bg-gray-100 dark:bg-gray-800 border-none outline-none text-sm shadow-inner" /><Icon path={icons.search} className="absolute left-3 top-3.5 w-4 h-4 text-gray-400" /></div>
                                
                                <div className="rounded-3xl bg-white dark:bg-gray-900 text-gray-900 dark:text-white p-6 md:p-12 mb-6 relative overflow-hidden shadow-lg border border-gray-200 dark:border-gray-800">
                                    <div className="absolute inset-0 bg-gradient-to-r from-indigo-50 to-fuchsia-50 dark:from-violet-900 dark:to-fuchsia-900 opacity-100 dark:opacity-40"></div>
                                    <div className="relative z-10">
                                        <div className="flex items-center gap-2 mb-3">
                                            <span className="bg-white/60 dark:bg-white/20 backdrop-blur px-3 py-1 rounded-full text-xs font-bold border border-gray-300 dark:border-white/10 flex items-center gap-1 shadow-sm text-purple-700 dark:text-purple-200">
                                                <Icon path={icons.check} className="w-4 h-4"/> {heroSubtitle}
                                            </span>
                                        </div>
                                        <h2 className="text-3xl md:text-5xl font-black mb-6 tracking-tight drop-shadow-sm dark:drop-shadow-none">{heroTitle}</h2>
                                        <button onClick={() => document.getElementById('shop').scrollIntoView({behavior: 'smooth'})} className="bg-purple-600 hover:bg-purple-700 text-white px-8 py-3 rounded-full font-bold shadow-lg active:scale-95 transition-transform text-sm">Shop Now</button>
                                    </div>
                                </div>
                                
                                <div className="flex overflow-x-auto gap-3 pb-4 mb-4 no-scrollbar">
                                    <button 
                                        onClick={() => setActiveCategory('all')} 
                                        className={`whitespace-nowrap px-6 py-2 rounded-full text-sm font-bold transition-all ${activeCategory === 'all' ? 'bg-gray-900 dark:bg-white text-white dark:text-gray-900 shadow-lg' : 'bg-white dark:bg-gray-800 text-gray-600 dark:text-gray-300 border border-gray-200 dark:border-gray-700 hover:border-purple-500'}`}
                                    >
                                        All Products
                                    </button>
                                    {categories.map(c => (
                                        <button 
                                            key={c.id}
                                            onClick={() => setActiveCategory(c.id)} 
                                            className={`whitespace-nowrap px-6 py-2 rounded-full text-sm font-bold transition-all ${activeCategory === c.id ? 'bg-gray-900 dark:bg-white text-white dark:text-gray-900 shadow-lg' : 'bg-white dark:bg-gray-800 text-gray-600 dark:text-gray-300 border border-gray-200 dark:border-gray-700 hover:border-purple-500'}`}
                                        >
                                            {c.name}
                                        </button>
                                    ))}
                                </div>

                                <div id="shop" className="grid grid-cols-2 lg:grid-cols-4 gap-3 md:gap-6">
                                    {filteredProducts.map(product => {
                                        const inStock = product.inStock !== false; 
                                        const thumb = (product.images && product.images.length > 0) ? product.images[0] : product.image;
                                        const isWishlisted = wishlist.includes(product.id);
                                        return (
                                            <div key={product.id} onClick={() => setSelectedProduct(product)} className="bg-white dark:bg-gray-800 rounded-2xl p-3 shadow-sm border border-gray-100 dark:border-gray-700 flex flex-col h-full hover:shadow-md hover:border-purple-300 transition-all relative overflow-hidden group cursor-pointer">
                                                {product.offer && <div className="absolute top-0 right-0 bg-red-600 text-white text-[10px] font-black px-2 py-1 rounded-bl-lg shadow-md z-20">{product.offer}</div>}
                                                <button onClick={(e) => { e.stopPropagation(); toggleWishlist(e, product); }} className="absolute top-2 left-2 z-20 p-2 rounded-full bg-white/80 dark:bg-black/50 hover:scale-110 transition-transform"><Icon path={isWishlisted ? icons.heartSolid : icons.heart} className={`w-4 h-4 ${isWishlisted ? 'text-red-500' : 'text-gray-500 dark:text-gray-300'}`} /></button>
                                                <div className="relative aspect-square rounded-xl overflow-hidden mb-3 bg-gray-100 dark:bg-gray-900">
                                                    {thumb ? <img loading="lazy" src={thumb} className={`w-full h-full object-cover transition-transform duration-500 group-hover:scale-110 ${!inStock ? 'grayscale opacity-50' : ''}`} /> : <div className="flex items-center justify-center h-full text-xs text-gray-400">No Image</div>}
                                                    {!inStock && <div className="absolute inset-0 flex items-center justify-center bg-black/40 z-10"><span className="bg-white text-gray-900 px-3 py-1 rounded-full text-[10px] font-black uppercase tracking-wider">Out of Stock</span></div>}
                                                </div>
                                                <h3 className="font-bold text-sm text-gray-900 dark:text-white truncate">{product.name}</h3>
                                                <div className="flex items-center gap-1 mt-1"><div className="flex text-yellow-400 text-[10px]">{[...Array(4)].map((_,i)=><Icon key={i} path={icons.star} className="w-3 h-3"/>)}<Icon path={icons.star} className="w-3 h-3 text-gray-300"/></div></div>
                                                <div className="flex items-end justify-between mt-3">
                                                    <div className="flex flex-col">{product.originalPrice && parseFloat(product.originalPrice) > parseFloat(product.price) && <span className="text-xs text-gray-400 line-through">‚Çπ{product.originalPrice}</span>}<span className="font-black text-gray-900 dark:text-white text-lg">‚Çπ{product.price}</span></div>
                                                    <button onClick={(e) => { e.stopPropagation(); addToCart(product); }} disabled={!inStock} className={`${!inStock ? 'bg-gray-300 cursor-not-allowed dark:bg-gray-700' : 'bg-purple-100 dark:bg-purple-900 text-purple-600 dark:text-purple-300 active:scale-90 hover:bg-purple-200'} w-8 h-8 rounded-full flex items-center justify-center transition-transform`}><Icon path={icons.plus} className="w-5 h-5"/></button>
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                                {products.length === 0 && <div className="text-center py-20 text-gray-400 text-sm">Shop is empty. Admin, add products!</div>}
                                {products.length > 0 && filteredProducts.length === 0 && <div className="text-center py-20 text-gray-400 text-sm">No products matched your search or category.</div>}
                                
                                <div className="mt-12">
                                    <div className="flex justify-between items-center mb-4"><h3 className="text-xl font-bold">Reviews</h3><button onClick={() => setView('feedback')} className="text-xs font-bold text-purple-600 bg-purple-50 px-3 py-1 rounded-full hover:bg-purple-100">Write Review</button></div>
                                    {feedbacks.length === 0 ? <p className="text-sm text-gray-400">No reviews yet.</p> : (<div className="grid md:grid-cols-3 gap-4">{feedbacks.slice(0, 3).map((f, i) => (<div key={i} className="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700"><div className="flex justify-between items-start mb-2"><div className="flex text-yellow-400 text-xs">{[...Array(parseInt(f.rating || 5))].map((_, idx) => <Icon key={idx} path={icons.star} className="w-3 h-3"/>)}</div><span className="text-[10px] text-gray-400">{f.date}</span></div><p className="text-xs text-gray-600 dark:text-gray-300 italic mb-2">"{f.message}"</p>{f.image && <img loading="lazy" src={f.image} className="w-16 h-16 rounded-lg object-cover mb-2 border border-gray-200" />}<p className="text-xs font-bold">- {f.name}</p></div>))}</div>)}
                                </div>
                            </div>
                        )}

                        {view === 'track' && (
                            <div className="max-w-md mx-auto glass p-6 rounded-3xl shadow-lg mt-4 animate-slide-up">
                                <h2 className="text-2xl font-bold mb-2">{currentUser ? `Welcome back, ${currentUser.name.split(' ')[0]}!` : "Track Order üì¶"}</h2>
                                <p className="text-sm text-gray-500 mb-6">{currentUser ? "Here are your recent orders:" : "Enter your phone number to find your orders"}</p>
                                {!currentUser && (
                                    <input type="tel" placeholder="Phone Number" value={trackPhone} onChange={e => setTrackPhone(e.target.value)} className="w-full bg-gray-50 dark:bg-gray-800 border-none rounded-xl px-4 py-3 outline-none mb-6 focus:ring-2 focus:ring-purple-500" />
                                )}
                                <div className="space-y-4">
                                    {orders.filter(o => o.customer.phone === trackPhone).length > 0 ? (
                                        orders.filter(o => o.customer.phone === trackPhone).reverse().map(order => (
                                            <div key={order.id} className="bg-white dark:bg-gray-800 p-4 rounded-xl border border-gray-100 dark:border-gray-700 shadow-sm">
                                                <div className="flex justify-between font-bold text-purple-600 dark:text-purple-400 mb-1">
                                                    <span>#{order.id}</span>
                                                    <span className={`px-2 py-0.5 rounded text-[10px] uppercase ${order.status === 'Cancelled' ? 'bg-red-100 text-red-600' : 'bg-purple-100'}`}>{order.status}</span>
                                                </div>
                                                <p className="text-xs text-gray-500">{order.date} ‚Ä¢ ‚Çπ{order.total}</p>
                                            </div>
                                        ))
                                    ) : (
                                        trackPhone && <p className="text-center text-sm text-gray-400">No orders found.</p>
                                    )}
                                    {currentUser && (
                                        <button onClick={() => setView('home')} className="w-full py-3 text-purple-600 text-sm font-bold bg-purple-50 dark:bg-purple-900/30 rounded-xl mt-4 hover:bg-purple-100 transition-colors">Continue Shopping</button>
                                    )}
                                </div>
                            </div>
                        )}

                        {view === 'feedback' && (
                            <div className="max-w-md mx-auto glass p-6 rounded-3xl shadow-lg mt-4 animate-slide-up">
                                <h2 className="text-2xl font-bold mb-2">Write Review üì∏</h2>
                                <div className="space-y-3">
                                    <input placeholder="Name" value={feedbackForm.name} onChange={e => setFeedbackForm({...feedbackForm, name: e.target.value})} className="w-full p-3 bg-gray-50 dark:bg-gray-800 rounded-xl outline-none" readOnly={!!currentUser} />
                                    <select value={feedbackForm.rating} onChange={e => setFeedbackForm({...feedbackForm, rating: e.target.value})} className="w-full p-3 bg-gray-50 dark:bg-gray-800 rounded-xl outline-none"><option value="5">5 Stars</option><option value="4">4 Stars</option></select>
                                    <div className="relative border-2 border-dashed border-gray-300 dark:border-gray-700 rounded-xl p-4 text-center">{feedbackForm.image ? (<div className="relative"><img src={feedbackForm.image} className="h-32 mx-auto rounded-lg" /><button onClick={() => setFeedbackForm({...feedbackForm, image: ''})} className="absolute top-0 right-0 bg-red-500 text-white p-1 rounded-full"><Icon path={icons.x} className="w-4 h-4"/></button></div>) : (<><Icon path={icons.camera} className="w-8 h-8 mx-auto text-gray-400 mb-2"/><p className="text-xs text-gray-500">Upload Photo</p><input type="file" onChange={(e) => handleImage(e, (res) => setFeedbackForm({...feedbackForm, image: res}))} className="absolute inset-0 opacity-0 w-full h-full" /></>)}</div>
                                    <textarea placeholder="Message" value={feedbackForm.message} onChange={e => setFeedbackForm({...feedbackForm, message: e.target.value})} className="w-full p-3 bg-gray-50 dark:bg-gray-800 rounded-xl outline-none h-24"></textarea>
                                    <button onClick={submitGlobalFeedback} className="w-full bg-purple-600 text-white py-3 rounded-xl font-bold shadow-lg">Submit</button>
                                </div>
                            </div>
                        )}

                        {view === 'wishlist' && (
                             <div className="animate-slide-up">
                                <div className="flex items-center gap-2 mb-6"><button onClick={() => setView('profile')}><Icon path={icons.return} className="w-5 h-5 text-gray-500 rotate-180" /></button><h2 className="text-2xl font-bold">My Wishlist ‚ù§Ô∏è</h2></div>
                                {wishlist.length === 0 ? (<div className="text-center py-20 text-gray-400"><p className="mb-4">Your wishlist is empty.</p><button onClick={() => setView('home')} className="bg-purple-100 text-purple-600 px-4 py-2 rounded-full text-sm font-bold">Go Shopping</button></div>) : (<div className="grid grid-cols-2 lg:grid-cols-4 gap-3 md:gap-6">{products.filter(p => wishlist.includes(p.id)).map(product => { const inStock = product.inStock !== false; const thumb = (product.images && product.images.length > 0) ? product.images[0] : product.image; return (<div key={product.id} onClick={() => setSelectedProduct(product)} className="bg-white dark:bg-gray-800 rounded-2xl p-3 shadow-sm border border-gray-100 dark:border-gray-700 flex flex-col h-full relative group cursor-pointer hover:border-purple-300 transition-all"><button onClick={(e) => { e.stopPropagation(); toggleWishlist(e, product); }} className="absolute top-2 left-2 z-20 p-2 rounded-full bg-red-100 text-red-500"><Icon path={icons.trash} className="w-4 h-4" /></button><div className="relative aspect-square rounded-xl overflow-hidden mb-3 bg-gray-100 dark:bg-gray-900">{thumb ? <img loading="lazy" src={thumb} className={`w-full h-full object-cover ${!inStock ? 'grayscale opacity-50' : ''}`} /> : <div className="flex items-center justify-center h-full text-xs text-gray-400">No Image</div>}</div><h3 className="font-bold text-sm text-gray-900 dark:text-white truncate">{product.name}</h3><div className="flex items-end justify-between mt-3"><span className="font-black text-gray-900 dark:text-white text-lg">‚Çπ{product.price}</span><button onClick={(e) => { e.stopPropagation(); addToCart(product); }} disabled={!inStock} className="bg-purple-100 dark:bg-purple-900 text-purple-600 dark:text-purple-300 w-8 h-8 rounded-full flex items-center justify-center hover:bg-purple-200 transition-colors"><Icon path={icons.plus} className="w-5 h-5"/></button></div></div>)})}</div>)}
                             </div>
                        )}
                        
                        {view === 'profile' && currentUser && (
                            <div className="max-w-md mx-auto mt-4 animate-slide-up">
                                <div className="glass p-6 rounded-3xl shadow-lg mb-4 text-center relative overflow-hidden">
                                     <div className="absolute top-0 left-0 w-full h-20 bg-gradient-to-r from-purple-500 to-indigo-600 opacity-20"></div>
                                    <div className="w-24 h-24 bg-white dark:bg-gray-800 text-purple-600 rounded-full flex items-center justify-center text-4xl font-bold mx-auto mb-3 shadow-md relative z-10 border-4 border-white dark:border-gray-900">{currentUser.name.charAt(0)}</div>
                                    <h2 className="text-2xl font-bold">{currentUser.name}</h2>
                                    <p className="text-gray-500 text-sm mb-4">{currentUser.phone}</p>
                                    <div className="flex justify-center gap-3"><button onClick={() => setView('wishlist')} className="flex items-center gap-2 bg-pink-50 dark:bg-pink-900/20 text-pink-600 px-4 py-2 rounded-full font-bold text-sm hover:bg-pink-100 transition-colors"><Icon path={icons.heartSolid} className="w-4 h-4"/> Wishlist</button><button onClick={logout} className="bg-red-50 dark:bg-red-900/20 text-red-600 px-4 py-2 rounded-full font-bold text-sm hover:bg-red-100 transition-colors">Logout</button></div>
                                </div>
                                <h3 className="text-lg font-bold mb-3 px-2">My Orders</h3>
                                <div className="space-y-4">
                                    {orders.filter(o => o.customer.customerId === currentUser.phone).length === 0 ? <p className="text-center text-gray-400 py-4">No orders placed yet.</p> :
                                        orders.filter(o => o.customer.customerId === currentUser.phone).reverse().map(order => (
                                            <div key={order.id} className="bg-white dark:bg-gray-900 p-4 rounded-xl border border-gray-100 dark:border-gray-700 shadow-sm relative">
                                                <div className="flex justify-between font-bold text-purple-600 dark:text-purple-400 mb-1"><span>#{order.id}</span><span className={`px-2 py-0.5 rounded text-[10px] uppercase ${order.status === 'Cancelled' ? 'bg-red-100 text-red-600' : order.status === 'Returned' ? 'bg-orange-100 text-orange-600' : 'bg-purple-100 dark:bg-purple-900/30'}`}>{order.status}</span></div>
                                                <div className="flex justify-between text-xs text-gray-500 mb-2"><span>{order.date}</span><span className="font-bold">Total: ‚Çπ{order.total}</span></div>
                                                <div className="text-xs text-gray-600 dark:text-gray-400 p-2 bg-gray-50 dark:bg-gray-800 rounded mb-2">{order.items.map(i => <div key={i.id}>{i.name} x {i.qty}</div>)}</div>
                                                {order.returnRequest && (<div className={`text-xs p-2 rounded mt-2 font-bold ${order.returnRequest.status === 'Approved' ? 'bg-green-100 text-green-700' : order.returnRequest.status === 'Rejected' ? 'bg-red-100 text-red-700' : 'bg-yellow-100 text-yellow-700'}`}>Return Status: {order.returnRequest.status}</div>)}
                                                {order.status === 'Delivered' && !order.returnRequest && (<button onClick={() => initiateReturn(order)} className="w-full mt-2 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-xs font-bold text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors">Request Return</button>)}
                                            </div>
                                        ))
                                    }
                                </div>
                            </div>
                        )}

                        {view === 'admin' && isOwner && (
                            <div className="max-w-4xl mx-auto mt-4 animate-slide-up">
                                {!isAdmin ? (
                                    <div className="glass p-8 rounded-3xl text-center max-w-sm mx-auto shadow-xl">
                                        <h2 className="text-xl font-bold mb-4">Admin Access</h2>
                                        <input type="password" placeholder="Enter Password" value={adminPassInput} onChange={e => setAdminPassInput(e.target.value)} className="w-full p-3 rounded-xl bg-gray-50 dark:bg-gray-800 mb-4 outline-none"/>
                                        <button onClick={adminLogin} className="w-full bg-purple-600 text-white py-3 rounded-xl font-bold">Login</button>
                                    </div>
                                ) : (
                                    <div className="space-y-6">
                                        <div className="flex justify-between items-center bg-white dark:bg-gray-900 p-4 rounded-xl border border-gray-100 dark:border-gray-700">
                                            <h3 className="font-bold text-sm">Data Management</h3>
                                            <div className="flex gap-2">
                                                <input type="file" ref={fileInputRef} onChange={importData} accept=".json" className="hidden" />
                                                <button onClick={() => fileInputRef.current.click()} className="flex items-center gap-1 bg-gray-100 dark:bg-gray-800 px-3 py-1.5 rounded-lg text-xs font-bold hover:bg-gray-200 dark:hover:bg-gray-700"><Icon path={icons.upload} className="w-4 h-4"/> Import</button>
                                                <button onClick={exportData} className="flex items-center gap-1 bg-blue-50 dark:bg-blue-900/30 text-blue-600 px-3 py-1.5 rounded-lg text-xs font-bold hover:bg-blue-100"><Icon path={icons.download} className="w-4 h-4"/> Export</button>
                                            </div>
                                        </div>
                                        <div className="flex p-1 bg-gray-200 dark:bg-gray-800 rounded-xl">
                                            {['products', 'orders', 'settings'].map(tab => (
                                                <button key={tab} onClick={() => setAdminTab(tab)} className={`flex-1 py-2 rounded-lg font-bold text-sm transition-all capitalize ${adminTab === tab ? 'bg-white dark:bg-gray-700 shadow text-purple-600' : 'text-gray-500'}`}>{tab}</button>
                                            ))}
                                        </div>
                                        {adminTab === 'products' && (
                                            <div className="glass p-4 md:p-6 rounded-3xl shadow-lg">
                                                <h2 className="text-lg font-bold mb-4">{productForm.id ? 'Edit Product' : 'Add New Product'}</h2>
                                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                                    <input placeholder="Name" value={productForm.name} onChange={e => setProductForm({...productForm, name: e.target.value})} className="p-3 bg-gray-50 dark:bg-gray-800 rounded-xl outline-none" />
                                                    <div className="grid grid-cols-2 gap-3">
                                                        <div><input type="number" placeholder="MRP (Old)" value={productForm.originalPrice} onChange={e => setProductForm({...productForm, originalPrice: e.target.value})} className="w-full p-3 bg-gray-50 dark:bg-gray-800 rounded-xl outline-none mb-1" /><span className="text-[10px] text-gray-500 ml-1">Optional</span></div>
                                                        <div><input type="number" placeholder="Price" value={productForm.price} onChange={e => setProductForm({...productForm, price: e.target.value})} className="w-full p-3 bg-gray-50 dark:bg-gray-800 rounded-xl outline-none mb-1 font-bold" /></div>
                                                    </div>
                                                    <div className="grid grid-cols-2 gap-3">
                                                        <div><input type="number" placeholder="Delivery Fee" value={productForm.deliveryFee} onChange={e => setProductForm({...productForm, deliveryFee: e.target.value})} className="w-full p-3 bg-gray-50 dark:bg-gray-800 rounded-xl outline-none mb-1" /></div>
                                                        <div className="flex items-center gap-2 px-3 bg-gray-50 dark:bg-gray-800 rounded-xl"><input type="checkbox" checked={productForm.returnable} onChange={e => setProductForm({...productForm, returnable: e.target.checked})} /><span className="text-sm">Returnable</span></div>
                                                    </div>
                                                    <div className="grid grid-cols-2 gap-3">
                                                        <input placeholder="Offer Tag" value={productForm.offer} onChange={e => setProductForm({...productForm, offer: e.target.value})} className="p-3 bg-gray-50 dark:bg-gray-800 rounded-xl outline-none" />
                                                        <label className="flex items-center gap-2 p-3 bg-gray-50 dark:bg-gray-800 rounded-xl cursor-pointer"><input type="checkbox" checked={productForm.inStock} onChange={e => setProductForm({...productForm, inStock: e.target.checked})} /><span className="text-sm font-bold">In Stock</span></label>
                                                    </div>
                                                    <select value={productForm.category} onChange={e => setProductForm({...productForm, category: e.target.value})} className="p-3 bg-gray-50 dark:bg-gray-800 rounded-xl outline-none">
                                                        {categories.length === 0 && <option value="general">General</option>}
                                                        {categories.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}
                                                    </select>
                                                    <div className="md:col-span-2 bg-gray-50 dark:bg-gray-800 p-3 rounded-xl">
                                                        <p className="text-xs text-gray-500 mb-2">Images (Add 1 or more)</p>
                                                        <div className="flex flex-wrap gap-2 mb-2">
                                                            {productForm.images && productForm.images.map((img, idx) => (
                                                                <div key={idx} className="relative w-16 h-16"><img loading="lazy" src={img} className="w-full h-full object-cover rounded-lg border"/><button onClick={() => removeProductImage(idx)} className="absolute -top-1 -right-1 bg-red-500 text-white rounded-full p-0.5"><Icon path={icons.x} className="w-3 h-3"/></button></div>
                                                            ))}
                                                        </div>
                                                        <input type="file" multiple onChange={handleProductImages} className="text-sm" />
                                                    </div>
                                                    <textarea placeholder="Description" value={productForm.description} onChange={e => setProductForm({...productForm, description: e.target.value})} className="md:col-span-2 p-3 bg-gray-50 dark:bg-gray-800 rounded-xl outline-none h-24"></textarea>
                                                </div>
                                                <button onClick={saveProduct} className="w-full bg-green-500 text-white py-3 rounded-xl font-bold hover:bg-green-600 transition-colors shadow-lg mb-8">{productForm.id ? 'Update Product' : 'Add Product'}</button>
                                                <h3 className="font-bold mb-4 text-sm text-gray-500 uppercase tracking-wider">Inventory</h3>
                                                <div className="space-y-3">
                                                    {products.map(p => {
                                                        const thumb = (p.images && p.images.length > 0) ? p.images[0] : p.image;
                                                        return (
                                                            <div key={p.id} className="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-3 p-3 bg-white dark:bg-gray-900 rounded-xl border border-gray-100 dark:border-gray-800 shadow-sm">
                                                                <div className="flex items-center gap-3 w-full sm:w-auto">
                                                                    {thumb && <img loading="lazy" src={thumb} className={`w-10 h-10 rounded-lg object-cover ${!p.inStock && 'grayscale'}`}/>}
                                                                    <div><p className="font-bold text-sm flex items-center gap-2">{p.name}{p.inStock === false && <span className="text-[9px] bg-red-100 text-red-600 px-1.5 py-0.5 rounded uppercase">Out of Stock</span>}</p><p className="text-xs text-gray-500">‚Çπ{p.price} {p.originalPrice && <span className="line-through text-gray-400 ml-1">‚Çπ{p.originalPrice}</span>}<span className="text-red-500 font-bold ml-1">{p.offer}</span></p></div>
                                                                </div>
                                                                <div className="flex gap-2 self-end sm:self-auto"><button onClick={() => editProduct(p)} className="p-2 bg-blue-50 dark:bg-blue-900/30 text-blue-600 rounded-lg"><Icon path={icons.edit} className="w-4 h-4"/></button><button onClick={() => deleteProduct(p.id)} className="p-2 bg-red-50 dark:bg-red-900/30 text-red-600 rounded-lg"><Icon path={icons.trash} className="w-4 h-4"/></button></div>
                                                            </div>
                                                        );
                                                    })}
                                                </div>
                                            </div>
                                        )}
                                        {adminTab === 'orders' && (
                                            <div className="glass p-6 rounded-3xl shadow-lg">
                                                <h2 className="text-lg font-bold mb-4">Manage Orders</h2>
                                                <div className="bg-purple-50 dark:bg-gray-800 p-4 rounded-xl mb-6 border border-purple-100 dark:border-gray-700">
                                                    <h3 className="text-sm font-bold text-purple-700 dark:text-purple-400 mb-2">Inquire History</h3>
                                                    <div className="relative"><input type="text" placeholder="Search by Name or Phone..." value={adminSearch} onChange={e => setAdminSearch(e.target.value)} className="w-full pl-10 pr-4 py-2 rounded-lg text-sm border-none outline-none focus:ring-2 ring-purple-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white"/><Icon path={icons.search} className="absolute left-3 top-2.5 w-4 h-4 text-gray-400"/></div>
                                                </div>
                                                <div className="space-y-4">
                                                    {orders.length === 0 && <p className="text-center text-gray-400 py-10">No orders yet.</p>}
                                                    {orders.slice().reverse().filter(o => !adminSearch || o.customer.phone.includes(adminSearch) || o.customer.name.toLowerCase().includes(adminSearch.toLowerCase())).map(order => (
                                                        <div key={order.id} className={`bg-white dark:bg-gray-900 p-4 rounded-xl border shadow-sm ${order.returnRequest && order.returnRequest.status === 'Pending' ? 'border-orange-500 border-2' : 'border-gray-100 dark:border-gray-800'}`}>
                                                            <div className="flex justify-between items-start mb-3">
                                                                <div><span className="font-bold text-sm block">Order #{order.id}</span><span className="text-xs text-gray-500 font-mono mt-1 block">{order.date}</span><p className="text-sm font-semibold text-purple-600 mt-1">{order.customer.name} ({order.customer.phone})</p></div>
                                                                <div className="text-right"><span className="font-bold block">‚Çπ{order.total}</span><select value={order.status} onChange={(e) => updateOrderStatus(order.id, e.target.value)} className={`mt-1 text-xs p-1 rounded bg-gray-100 dark:bg-gray-800 border outline-none ${order.status === 'Cancelled' ? 'text-red-500 font-bold' : ''}`}><option value="Pending Verification">Pending</option><option value="Payment Received">Paid</option><option value="Shipped">Shipped</option><option value="Delivered">Delivered</option><option value="Returned">Returned</option><option value="Cancelled">Cancelled</option></select></div>
                                                            </div>
                                                            <div className="text-xs text-gray-600 dark:text-gray-400 p-2 bg-gray-50 dark:bg-gray-800 rounded">{order.items.map(i => <div key={i.id}>{i.name} x {i.qty}</div>)}</div>
                                                            {order.returnRequest && (<div className="mt-3 bg-orange-50 dark:bg-orange-900/20 p-3 rounded-lg border border-orange-100 dark:border-orange-900"><div className="flex justify-between items-start"><div className="text-xs"><strong className="text-orange-600">Return Requested</strong><p className="mt-1">Reason: "{order.returnRequest.reason}"</p><p className="text-[10px] text-gray-400">{order.returnRequest.date}</p></div>{order.returnRequest.status === 'Pending' ? (<div className="flex gap-2"><button onClick={() => handleReturnAction(order.id, 'Reject')} className="px-2 py-1 bg-white border border-gray-300 rounded text-xs text-red-600 font-bold">Reject</button><button onClick={() => handleReturnAction(order.id, 'Approve')} className="px-2 py-1 bg-green-600 rounded text-xs text-white font-bold">Approve</button></div>) : (<span className={`text-xs font-bold ${order.returnRequest.status === 'Approved' ? 'text-green-600' : 'text-red-600'}`}>{order.returnRequest.status}</span>)}</div></div>)}
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        )}
                                        {adminTab === 'settings' && (
                                            <div className="glass p-6 rounded-3xl shadow-lg max-w-xl mx-auto space-y-6">
                                                <h2 className="text-lg font-bold text-center mb-6">Admin Settings</h2>
                                                
                                                {/* Admin Highlights Editor */}
                                                <div className="bg-indigo-50 dark:bg-indigo-900/20 p-4 rounded-xl border border-indigo-100 dark:border-indigo-900/50">
                                                    <h3 className="text-sm font-bold text-indigo-600 dark:text-indigo-400 mb-3 flex items-center gap-2"><Icon path={icons.edit} className="w-4 h-4"/> Top Highlight Settings</h3>
                                                    <input type="text" placeholder="Main Highlight Title" value={adminHeroTitle} onChange={e => setAdminHeroTitle(e.target.value)} className="w-full p-2 text-sm rounded-lg border outline-none bg-white dark:bg-gray-700 text-gray-900 dark:text-white mb-2"/>
                                                    <input type="text" placeholder="Highlight Subtitle" value={adminHeroSubtitle} onChange={e => setAdminHeroSubtitle(e.target.value)} className="w-full p-2 text-sm rounded-lg border outline-none bg-white dark:bg-gray-700 text-gray-900 dark:text-white mb-3"/>
                                                    
                                                    <h3 className="text-sm font-bold text-indigo-600 dark:text-indigo-400 mt-4 mb-2">Trending News Ticker</h3>
                                                    <input type="text" placeholder="Scrolling news text..." value={adminTrending} onChange={e => setAdminTrending(e.target.value)} className="w-full p-2 text-sm rounded-lg border outline-none bg-white dark:bg-gray-700 text-gray-900 dark:text-white mb-4"/>
                                                    
                                                    <button onClick={saveHighlights} className="w-full bg-indigo-600 text-white py-2 rounded-lg text-sm font-bold shadow hover:bg-indigo-700 transition-colors">Save Frontpage Updates</button>
                                                </div>

                                                <div className="bg-green-50 dark:bg-green-900/20 p-4 rounded-xl border border-green-100 dark:border-green-900/50">
                                                    <h3 className="text-sm font-bold text-green-600 dark:text-green-400 mb-3 flex items-center gap-2"><Icon path={icons.plus} className="w-4 h-4"/> Categories</h3>
                                                    <div className="flex gap-2 mb-3">
                                                        <input type="text" placeholder="New Category Name" value={newCat} onChange={e => setNewCat(e.target.value)} className="flex-1 p-2 text-sm rounded-lg border outline-none bg-white dark:bg-gray-700 text-gray-900 dark:text-white"/>
                                                        <button onClick={addCategory} className="bg-green-600 text-white px-4 rounded-lg text-sm font-bold shadow hover:bg-green-700 transition-colors">Add</button>
                                                    </div>
                                                    <div className="flex flex-wrap gap-2">
                                                        {categories.map(c => (
                                                            <span key={c.id} className="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 px-3 py-1 rounded-full text-xs font-bold flex items-center gap-2 shadow-sm">
                                                                {c.name}
                                                                <button onClick={() => deleteCategory(c.id)} className="text-red-500 hover:text-red-700"><Icon path={icons.x} className="w-3 h-3"/></button>
                                                            </span>
                                                        ))}
                                                    </div>
                                                </div>

                                                <div className="bg-red-50 dark:bg-red-900/20 p-4 rounded-xl border border-red-100 dark:border-red-900/50">
                                                    <h3 className="text-sm font-bold text-red-600 dark:text-red-400 mb-3 flex items-center gap-2"><Icon path={icons.lock} className="w-4 h-4"/> Change Admin Password</h3>
                                                    <div className="space-y-3">
                                                        <input type="password" placeholder="Old Password" value={passChangeForm.old} onChange={e => setPassChangeForm({...passChangeForm, old:e.target.value})} className="w-full p-2 text-sm rounded-lg border outline-none bg-white dark:bg-gray-700 text-gray-900 dark:text-white"/>
                                                        <input type="password" placeholder="New Password" value={passChangeForm.new} onChange={e => setPassChangeForm({...passChangeForm, new:e.target.value})} className="w-full p-2 text-sm rounded-lg border outline-none bg-white dark:bg-gray-700 text-gray-900 dark:text-white"/>
                                                        <input type="password" placeholder="Confirm New Password" value={passChangeForm.confirm} onChange={e => setPassChangeForm({...passChangeForm, confirm:e.target.value})} className="w-full p-2 text-sm rounded-lg border outline-none bg-white dark:bg-gray-700 text-gray-900 dark:text-white"/>
                                                        <button onClick={changeAdminPassword} className="w-full bg-red-600 text-white py-2 rounded-lg text-sm font-bold shadow hover:bg-red-700 transition-colors">Update Password</button>
                                                    </div>
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                )}
                            </div>
                        )}
                    </main>

                    <nav className="fixed bottom-0 w-full bg-white/90 dark:bg-gray-900/90 backdrop-blur-md border-t border-gray-200 dark:border-gray-800 md:hidden z-50 pb-safe">
                        <div className="flex justify-around items-center py-3">
                            <a href="#shop" onClick={(e) => { e.preventDefault(); setView('home'); }} className={`flex flex-col items-center text-[10px] gap-1 ${view === 'home' ? 'text-purple-600' : 'text-gray-400'}`}><Icon path={icons.home} className="w-6 h-6" /> Shop</a>
                            <a href="#profile" onClick={(e) => { e.preventDefault(); currentUser ? setView('profile') : setShowAuthModal(true); }} className={`flex flex-col items-center text-[10px] gap-1 ${view === 'profile' ? 'text-purple-600' : 'text-gray-400'}`}><Icon path={icons.user} className="w-6 h-6" /> {currentUser ? 'My Orders' : 'Login'}</a>
                            <a href="#cart" onClick={(e) => { e.preventDefault(); setShowCart(true); }} className="flex flex-col items-center text-[10px] gap-1 text-gray-400 relative"><div className="relative"><Icon path={icons.cart} className="w-6 h-6" />{cart.length > 0 && <span className="absolute -top-1 -right-1 w-2.5 h-2.5 bg-red-500 rounded-full border-2 border-white dark:border-gray-900"></span>}</div>Cart</a>
                            {isOwner && (
                                <a href="#admin" onClick={(e) => { e.preventDefault(); setView('admin'); }} className={`flex flex-col items-center text-[10px] gap-1 opacity-25 hover:opacity-100 transition-opacity ${view === 'admin' ? 'text-purple-600 opacity-100' : 'text-gray-400'}`}><Icon path={icons.lock} className="w-6 h-6" /> Admin</a>
                            )}
                        </div>
                    </nav>

                    <footer className="hidden md:block mt-auto py-8 bg-white dark:bg-gray-900 border-t border-gray-100 dark:border-gray-800">
                        <div className="max-w-7xl mx-auto px-4 text-center">
                            <h2 className="font-bold text-gray-900 dark:text-white">DBP Mart</h2>
                            <div onClick={() => setShowDBP(true)} className="inline-block mt-4 bg-gray-50 dark:bg-gray-800 px-4 py-2 rounded-xl border border-gray-200 dark:border-gray-700 cursor-pointer hover:bg-gray-100 transition-colors">
                                <p className="text-[10px] font-bold text-gray-400 uppercase">Powered By</p>
                                <p className="text-sm font-black text-blue-600 dark:text-blue-400">DBP Systems</p>
                            </div>
                        </div>
                    </footer>

                    {/* Modals & Popups */}

                    {showAuthModal && (
                        <div className="fixed inset-0 z-[140] flex items-center justify-center p-4">
                            <div className="absolute inset-0 bg-black/70 backdrop-blur-md" onClick={() => setShowAuthModal(false)}></div>
                            <div className="bg-white dark:bg-gray-900 w-full max-w-sm rounded-2xl p-8 relative shadow-2xl animate-slide-up">
                                <button onClick={() => setShowAuthModal(false)} className="absolute top-4 right-4 text-gray-400 hover:text-red-500"><Icon path={icons.x} className="w-6 h-6"/></button>
                                <h2 className="text-2xl font-bold mb-1 text-center">{authMode === 'login' ? 'Welcome Back!' : 'Create Account'}</h2>
                                <p className="text-sm text-gray-500 text-center mb-6">{authMode === 'login' ? 'Sign in to access your orders' : 'Join us to track orders easily'}</p>
                                <div className="space-y-4">
                                    {authMode === 'signup' && <input placeholder="Full Name" value={authForm.name} onChange={e => setAuthForm({...authForm, name: e.target.value})} className="w-full p-4 bg-gray-50 dark:bg-gray-800 rounded-xl outline-none border border-transparent focus:border-purple-500"/>}
                                    <input type="tel" placeholder="Phone Number" value={authForm.phone} onChange={e => setAuthForm({...authForm, phone: e.target.value})} className="w-full p-4 bg-gray-50 dark:bg-gray-800 rounded-xl outline-none border border-transparent focus:border-purple-500"/>
                                    <input type="password" placeholder="Password" value={authForm.password} onChange={e => setAuthForm({...authForm, password: e.target.value})} className="w-full p-4 bg-gray-50 dark:bg-gray-800 rounded-xl outline-none border border-transparent focus:border-purple-500"/>
                                    <button onClick={handleAuth} className="w-full bg-purple-600 text-white py-4 rounded-xl font-bold shadow-lg active:scale-95 transition-transform">{authMode === 'login' ? 'Sign In' : 'Sign Up'}</button>
                                    <div className="text-center text-sm mt-4"><span className="text-gray-500">{authMode === 'login' ? "Don't have an account? " : "Already have an account? "}</span><button onClick={() => setAuthMode(authMode === 'login' ? 'signup' : 'login')} className="font-bold text-purple-600">{authMode === 'login' ? 'Sign Up' : 'Log In'}</button></div>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {returnModalOpen && (
                        <div className="fixed inset-0 z-[150] flex items-center justify-center p-4">
                            <div className="absolute inset-0 bg-black/60 backdrop-blur-sm" onClick={() => setReturnModalOpen(false)}></div>
                            <div className="bg-white dark:bg-gray-900 w-full max-w-sm rounded-2xl p-6 relative shadow-2xl animate-slide-up">
                                <h3 className="text-xl font-bold mb-4">Request Return</h3>
                                <p className="text-sm text-gray-500 mb-4">Why are you returning this item?</p>
                                <textarea value={returnReason} onChange={(e) => setReturnReason(e.target.value)} placeholder="Wrong size, damaged, etc..." className="w-full p-3 bg-gray-50 dark:bg-gray-800 rounded-xl outline-none h-32 mb-4 border border-gray-200 dark:border-gray-700"></textarea>
                                <div className="flex gap-3"><button onClick={() => setReturnModalOpen(false)} className="flex-1 py-3 text-gray-500 font-bold">Cancel</button><button onClick={submitReturn} className="flex-1 bg-red-500 text-white py-3 rounded-xl font-bold shadow-lg">Submit Request</button></div>
                            </div>
                        </div>
                    )}
                    
                    {selectedProduct && (
                        <div className="fixed inset-0 z-[100] bg-gray-100 dark:bg-gray-950 flex flex-col animate-slide-up overflow-y-auto">
                            <div className="sticky top-0 bg-white/90 dark:bg-gray-900/90 backdrop-blur-md p-4 flex items-center justify-between border-b border-gray-200 dark:border-gray-800 z-40">
                                <h2 className="text-sm font-bold truncate pr-4 text-gray-600 dark:text-gray-300">DBP Mart &gt; {categories.find(c => c.id === selectedProduct.category)?.name || 'General'} &gt; {selectedProduct.name}</h2>
                                <button onClick={() => setSelectedProduct(null)} className="p-2 rounded-full bg-gray-200 dark:bg-gray-800 hover:bg-gray-300 dark:hover:bg-gray-700 transition-colors"><Icon path={icons.x} className="w-5 h-5" /></button>
                            </div>
                            <div className="flex-1 max-w-7xl mx-auto w-full pb-24 md:pb-8">
                                <div className="grid md:grid-cols-2 gap-0 md:gap-8 bg-white dark:bg-gray-900 md:my-8 md:rounded-3xl md:shadow-xl overflow-hidden">
                                    <div className="bg-white dark:bg-gray-900 p-4 md:p-8 flex flex-col items-center border-b md:border-b-0 md:border-r border-gray-100 dark:border-gray-800">
                                        
                                        {/* Main Active Image Display */}
                                        <div className="aspect-square w-full max-w-md relative rounded-2xl overflow-hidden mb-4">
                                            {galleryImages.length > 0 ? <img loading="lazy" src={galleryImages[activeImageIdx]} className={`w-full h-full object-contain transition-opacity duration-300 ${selectedProduct.inStock === false ? 'grayscale opacity-50' : ''}`} /> : <div className="flex items-center justify-center h-full text-gray-400 bg-gray-50 dark:bg-gray-800">No Image Available</div>}
                                        </div>
                                        
                                        {/* Interactive Thumbnail Gallery */}
                                        {galleryImages.length > 1 && (
                                            <div className="flex gap-2 overflow-x-auto w-full justify-center pb-2">
                                                {galleryImages.map((img, idx) => (
                                                    <button key={idx} onMouseEnter={() => setActiveImageIdx(idx)} onClick={() => setActiveImageIdx(idx)} className={`w-14 h-14 rounded-lg border overflow-hidden shrink-0 transition-all ${activeImageIdx === idx ? 'border-purple-600 ring-2 ring-purple-300' : 'border-gray-200 dark:border-gray-700 opacity-70 hover:opacity-100'}`}>
                                                        <img src={img} className="w-full h-full object-cover"/>
                                                    </button>
                                                ))}
                                            </div>
                                        )}
                                    </div>

                                    <div className="p-6 md:p-8 flex flex-col h-full overflow-y-auto">
                                        <h1 className="text-2xl md:text-3xl font-medium text-gray-900 dark:text-white leading-tight mb-2">{selectedProduct.name}</h1>
                                        <div className="flex items-center gap-1 mb-4 border-b border-gray-100 dark:border-gray-800 pb-4">
                                            <div className="flex text-yellow-500 text-sm">
                                                {[...Array(4)].map((_,i)=><Icon key={i} path={icons.star} className="w-4 h-4"/>)}<Icon path={icons.star} className="w-4 h-4 text-gray-300"/>
                                            </div>
                                            <span className="text-blue-600 dark:text-blue-400 text-sm font-medium ml-1">{feedbacks.filter(f => f.productId === selectedProduct.id).length} ratings</span>
                                        </div>
                                        <div className="mb-6">
                                            <div className="flex items-baseline gap-2">
                                                {selectedProduct.originalPrice && parseFloat(selectedProduct.originalPrice) > parseFloat(selectedProduct.price) && (
                                                    <span className="text-red-500 text-xl font-light">-{Math.round(((parseFloat(selectedProduct.originalPrice) - parseFloat(selectedProduct.price)) / parseFloat(selectedProduct.originalPrice)) * 100)}%</span>
                                                )}
                                                <span className="text-4xl font-medium text-gray-900 dark:text-white">‚Çπ{selectedProduct.price}</span>
                                            </div>
                                            {selectedProduct.originalPrice && <div className="text-gray-500 text-sm mt-1">M.R.P.: <span className="line-through">‚Çπ{selectedProduct.originalPrice}</span></div>}
                                            <div className="text-sm text-gray-900 dark:text-white mt-1 font-bold">Inclusive of all taxes</div>
                                            <div className="mt-3 text-sm text-gray-600 dark:text-gray-300 space-y-1"><p>üöö <strong>Delivery:</strong> {selectedProduct.deliveryFee > 0 ? `‚Çπ${selectedProduct.deliveryFee}` : <span className="text-green-600">FREE</span>}</p><p>‚Ü©Ô∏è <strong>Policy:</strong> {selectedProduct.returnable ? "7 Days Returnable" : "Non-Returnable"}</p></div>
                                        </div>
                                        
                                        <div className="border border-gray-200 dark:border-gray-700 rounded-xl p-4 mb-6">
                                            <div className={`text-lg font-medium mb-4 ${selectedProduct.inStock !== false ? 'text-green-600' : 'text-red-600'}`}>{selectedProduct.inStock !== false ? 'In Stock.' : 'Currently Unavailable.'}</div>
                                            
                                            {/* Desktop Action Buttons */}
                                            {selectedProduct.inStock !== false && (
                                                <div className="hidden md:flex flex-col gap-3">
                                                    <button onClick={() => addToCart(selectedProduct)} className="w-full bg-yellow-400 hover:bg-yellow-500 text-gray-900 py-3 rounded-full font-medium shadow-sm text-sm active:scale-95 transition-transform">Add to Cart</button>
                                                    <button onClick={() => buyNow(selectedProduct)} className="w-full bg-orange-500 hover:bg-orange-600 text-white py-3 rounded-full font-medium shadow-sm text-sm active:scale-95 transition-transform">Buy Now</button>
                                                </div>
                                            )}
                                            <div className="flex items-center gap-2 text-xs text-gray-500 mt-4"><Icon path={icons.lock} className="w-3 h-3"/><span>Secure transaction via DBP</span></div>
                                        </div>
                                        
                                        <div className="mt-2"><h3 className="font-bold text-lg mb-2">About this item</h3><ul className="list-disc pl-5 space-y-2 text-sm text-gray-700 dark:text-gray-300 leading-relaxed"><li><strong>Premium Quality:</strong> Built with high-grade materials for reliable performance.</li><li><strong>Description:</strong> {selectedProduct.description || "A high-quality component perfect for your next project."}</li></ul></div>
                                    </div>
                                </div>
                                
                                <div className="p-4 md:p-0 mb-8 max-w-7xl mx-auto">
                                    <h3 className="text-lg font-bold mb-4">Recommended for You</h3>
                                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                        {products.filter(p => p.category === selectedProduct.category && p.id !== selectedProduct.id).slice(0, 4).map(rp => {
                                            const rpThumb = (rp.images && rp.images.length > 0) ? rp.images[0] : rp.image;
                                            return (
                                                <div key={rp.id} onClick={() => setSelectedProduct(rp)} className="bg-white dark:bg-gray-900 p-3 rounded-xl shadow-sm border border-gray-100 dark:border-gray-800 block cursor-pointer hover:border-purple-500 transition-colors">
                                                    <img src={rpThumb} className="w-full h-32 object-cover rounded-lg mb-2"/>
                                                    <h4 className="font-bold text-xs truncate">{rp.name}</h4>
                                                    <p className="text-purple-600 text-sm font-bold">‚Çπ{rp.price}</p>
                                                </div>
                                            )
                                        })}
                                    </div>
                                </div>

                                <div className="p-4 md:p-0 md:mb-12 max-w-7xl mx-auto">
                                    <hr className="border-gray-200 dark:border-gray-800 my-8"/>
                                    <div className="grid md:grid-cols-2 gap-8">
                                        <div>
                                            <h3 className="text-xl font-bold mb-4">Customer Reviews</h3>
                                            <div className="space-y-4">
                                                {feedbacks.filter(f => f.productId === selectedProduct.id).length === 0 ? <p className="text-gray-500 text-sm">No reviews yet.</p> : 
                                                    feedbacks.filter(f => f.productId === selectedProduct.id).map((f, i) => (
                                                        <div key={i} className="flex gap-3 border-b border-gray-100 dark:border-gray-800 pb-3">
                                                            <div className="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center text-xs font-bold text-gray-600">{f.name.charAt(0)}</div>
                                                            <div>
                                                                <div className="text-sm font-bold">{f.name}</div>
                                                                <div className="flex text-yellow-500 text-xs my-1">{[...Array(parseInt(f.rating || 5))].map((_, idx) => <Icon key={idx} path={icons.star} className="w-3 h-3"/>)}</div>
                                                                <div className="text-sm text-gray-600 dark:text-gray-400">"{f.message}"</div>
                                                                {f.image && <img src={f.image} className="w-16 h-16 rounded mt-2 object-cover"/>}
                                                                <div className="text-[10px] text-gray-400 mt-1">{f.date}</div>
                                                            </div>
                                                        </div>
                                                    ))
                                                }
                                            </div>
                                        </div>
                                        <div className="bg-gray-50 dark:bg-gray-900 p-6 rounded-2xl h-fit">
                                            <h3 className="text-lg font-bold mb-3">Write a Review</h3>
                                            <div className="space-y-3">
                                                <input placeholder="Your Name" value={productReviewForm.name} onChange={e => setProductReviewForm({...productReviewForm, name: e.target.value})} className="w-full p-3 bg-white dark:bg-gray-800 rounded-xl outline-none border border-gray-200 dark:border-gray-700" readOnly={!!currentUser} />
                                                <select value={productReviewForm.rating} onChange={e => setProductReviewForm({...productReviewForm, rating: e.target.value})} className="w-full p-3 bg-white dark:bg-gray-800 rounded-xl outline-none border border-gray-200 dark:border-gray-700"><option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê (5)</option><option value="4">‚≠ê‚≠ê‚≠ê‚≠ê (4)</option><option value="3">‚≠ê‚≠ê‚≠ê (3)</option><option value="2">‚≠ê‚≠ê (2)</option><option value="1">‚≠ê (1)</option></select>
                                                <div className="relative border-2 border-dashed border-gray-300 dark:border-gray-700 rounded-xl p-4 text-center cursor-pointer bg-white dark:bg-gray-800">{productReviewForm.image ? (<div className="relative"><img src={productReviewForm.image} className="h-20 mx-auto rounded-lg" /><button onClick={() => setProductReviewForm({...productReviewForm, image: ''})} className="absolute top-0 right-0 bg-red-500 text-white p-1 rounded-full"><Icon path={icons.x} className="w-3 h-3"/></button></div>) : (<><Icon path={icons.camera} className="w-6 h-6 mx-auto text-gray-400 mb-1"/><p className="text-xs text-gray-500">Add Photo</p><input type="file" onChange={(e) => handleImage(e, (res) => setProductReviewForm({...productReviewForm, image: res}))} className="absolute inset-0 opacity-0 w-full h-full" /></>)}</div>
                                                <textarea placeholder="Your experience..." value={productReviewForm.message} onChange={e => setProductReviewForm({...productReviewForm, message: e.target.value})} className="w-full p-3 bg-white dark:bg-gray-800 rounded-xl outline-none h-20 border border-gray-200 dark:border-gray-700"></textarea>
                                                <button onClick={() => submitProductFeedback(selectedProduct.id)} className="w-full bg-blue-600 text-white py-3 rounded-xl font-bold shadow-lg flex items-center justify-center gap-2"><Icon path={icons.send} className="w-4 h-4"/> Submit Review</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            {/* Sticky Mobile Action Bar */}
                            {selectedProduct.inStock !== false && (
                                <div className="md:hidden fixed bottom-0 left-0 w-full bg-white dark:bg-gray-900 border-t border-gray-200 dark:border-gray-800 p-4 z-50 flex gap-3 shadow-[0_-4px_20px_rgba(0,0,0,0.05)] pb-safe">
                                    <button onClick={() => addToCart(selectedProduct)} className="flex-1 bg-yellow-400 active:bg-yellow-500 text-gray-900 py-3 rounded-xl font-bold text-sm flex items-center justify-center gap-2 shadow-sm"><Icon path={icons.cart} className="w-4 h-4"/> Add to Cart</button>
                                    <button onClick={() => buyNow(selectedProduct)} className="flex-1 bg-orange-500 active:bg-orange-600 text-white py-3 rounded-xl font-bold text-sm flex items-center justify-center gap-2 shadow-sm"><Icon path={icons.check} className="w-4 h-4"/> Buy Now</button>
                                </div>
                            )}
                        </div>
                    )}

                    {showCart && (
                        <div className="fixed inset-0 z-[120] flex justify-end" onClick={() => setShowCart(false)}>
                            <div className="flex-1 bg-black/30 backdrop-blur-sm"></div>
                            <div className="w-full md:w-96 bg-white dark:bg-gray-900 h-full p-6 shadow-2xl flex flex-col animate-slide-up" onClick={e => e.stopPropagation()}>
                                <div className="flex justify-between items-center mb-6"><h2 className="text-2xl font-bold">Your Bag</h2><button onClick={() => setShowCart(false)}><Icon path={icons.x} className="w-6 h-6"/></button></div>
                                <div className="flex-1 overflow-y-auto space-y-3 no-scrollbar">
                                    {cart.map(item => (
                                        <div key={item.id} className="flex gap-3 p-3 rounded-2xl bg-gray-50 dark:bg-gray-800 border border-gray-100 dark:border-gray-700">
                                            {item.image && <img src={item.image} className="w-16 h-16 rounded-lg object-cover bg-white"/>}
                                            <div className="flex-1"><h4 className="font-bold text-sm line-clamp-1">{item.name}</h4><div className="flex justify-between mt-2 items-center"><span className="text-purple-600 font-bold">‚Çπ{item.price * item.qty}</span><div className="flex items-center gap-3"><div className="flex items-center gap-2 bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg px-1 py-0.5"><button onClick={() => updateCartQty(item.id, -1)} className="w-6 h-6 flex items-center justify-center text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-800 rounded font-bold">-</button><span className="text-xs font-bold w-4 text-center">{item.qty}</span><button onClick={() => updateCartQty(item.id, 1)} className="w-6 h-6 flex items-center justify-center text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-800 rounded font-bold">+</button></div><button onClick={() => removeFromCart(item.id)} className="text-red-500 bg-red-50 dark:bg-red-900/20 p-1.5 rounded-lg hover:bg-red-100 transition-colors"><Icon path={icons.trash} className="w-4 h-4"/></button></div></div></div>
                                        </div>
                                    ))}
                                    {cart.length === 0 && <div className="text-center text-gray-400 py-10">Your bag is empty.</div>}
                                </div>
                                <div className="pt-4 mt-auto"><button disabled={cart.length === 0} onClick={() => {setShowCart(false); setShowCheckout(true)}} className="w-full bg-gray-900 dark:bg-white text-white dark:text-gray-900 py-4 rounded-xl font-bold shadow-lg disabled:opacity-50 disabled:cursor-not-allowed">Checkout (‚Çπ{cart.reduce((a,c) => a+(c.price*c.qty)+(c.deliveryFee||0)*c.qty, 0)})</button></div>
                            </div>
                        </div>
                    )}

                    {showCheckout && (
                        <div className="fixed inset-0 z-[130] flex items-center justify-center p-4">
                            <div className="absolute inset-0 bg-black/60 backdrop-blur-sm" onClick={() => setShowCheckout(false)}></div>
                            <div className="bg-white dark:bg-gray-900 rounded-3xl p-8 max-w-sm w-full relative shadow-2xl animate-slide-up max-h-[90vh] overflow-y-auto no-scrollbar">
                                <h2 className="text-2xl font-bold mb-4">Checkout</h2>
                                <div className="space-y-4 mb-6">
                                    <div><label className="text-xs font-bold text-gray-500 ml-1 mb-1 block">Contact Details</label><div className="space-y-3"><input placeholder="Full Name" value={checkoutForm.name} onChange={e => setCheckoutForm({...checkoutForm, name: e.target.value})} className="w-full p-4 bg-gray-50 dark:bg-gray-800 rounded-xl outline-none"/><input placeholder="Phone Number" value={checkoutForm.phone} onChange={e => setCheckoutForm({...checkoutForm, phone: e.target.value})} className="w-full p-4 bg-gray-50 dark:bg-gray-800 rounded-xl outline-none"/></div></div>
                                    <div><label className="text-xs font-bold text-gray-500 ml-1 mb-1 block">Shipping Address</label><div className="grid grid-cols-2 gap-3 mb-3"><input placeholder="Pincode" value={checkoutForm.pincode} onChange={e => setCheckoutForm({...checkoutForm, pincode: e.target.value})} className="w-full p-3 bg-gray-50 dark:bg-gray-800 rounded-xl outline-none"/><input placeholder="Country" value={checkoutForm.country} onChange={e => setCheckoutForm({...checkoutForm, country: e.target.value})} className="w-full p-3 bg-gray-50 dark:bg-gray-800 rounded-xl outline-none font-bold text-gray-500" readOnly/></div><div className="grid grid-cols-2 gap-3 mb-3"><input placeholder="State" value={checkoutForm.state} onChange={e => setCheckoutForm({...checkoutForm, state: e.target.value})} className="w-full p-3 bg-gray-50 dark:bg-gray-800 rounded-xl outline-none"/><input placeholder="District/City" value={checkoutForm.district} onChange={e => setCheckoutForm({...checkoutForm, district: e.target.value})} className="w-full p-3 bg-gray-50 dark:bg-gray-800 rounded-xl outline-none"/></div><textarea placeholder="House No, Building, Street, Landmark..." value={checkoutForm.detailedAddress} onChange={e => setCheckoutForm({...checkoutForm, detailedAddress: e.target.value})} className="w-full p-3 bg-gray-50 dark:bg-gray-800 rounded-xl outline-none h-24 resize-none"></textarea></div>
                                </div>
                                <div className="flex gap-4"><button onClick={() => setShowCheckout(false)} className="flex-1 py-3 font-bold text-gray-400">Cancel</button><button onClick={placeOrder} className="flex-1 bg-green-500 text-white py-3 rounded-xl font-bold shadow-lg">Proceed</button></div>
                            </div>
                        </div>
                    )}
                    {showDBP && <DBPModal onClose={() => setShowDBP(false)} />}
                </div>
            );
        };
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

